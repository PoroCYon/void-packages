# Template file for 'cross-${_triplet}-gcc'
_triplet=msp430-none-elf
_pkgname=gcc
pkgname=cross-${_triplet}-gcc
version=10.2.0
revision=1
wrksrc="gcc-${version/pre/_pre}"
#build_wrksrc=builddir/$wrksrc/build
build_style=gnu-configure
make_build_args="INHIBIT_LIBC_CFLAGS='-DUSE_TM_CLONE_REGISTRY=0'"
hostmakedepends="autoconf automake cross-msp430-none-elf-binutils bison flex
 perl tar texinfo"
makedepends="gmp-devel isl15-devel libmpc-devel mpfr-devel zlib-devel"
depends="cross-msp430-none-elf-binutils"
short_desc="GNU Compiler Collection"
maintainer="PoroCYon <porocyon@titandemo.org>"
license="GFDL-1.2-or-later, GPL-3.0-or-later, LGPL-2.1-or-later"
homepage="https://gcc.gnu.org"
distfiles="https://gcc.gnu.org/pub/gcc/releases/gcc-${version}/gcc-${version}.tar.xz"
checksum=b8dd4368bb9c7f0b98188317ee0254dd8cc99d1e3a18d0ff146c855fe16c1d8c
alternatives="msp430:/usr/bin/msp430-cc:/usr/bin/msp430-gcc"
nocross=yes
nopie=yes
nostrip_files="libgcc.a libgcov.a"
make_build_target="all-gcc all-target-libgcc"
make_build_args="-C build"
make_install_args="-C build"
make_install_target="install-gcc install-target-libgcc"

_target=$_triplet

post_extract() {
	mkdir -p build
}

pre_configure() {
	export CFLAGS_FOR_TARGET="-g -Os -ffunction-sections -fdata-sections -pipe"
	export CXXFLAGS_FOR_TARGET="-g -Os -ffunction-sections -fdata-sections -pipe"
	export AS_FOR_TARGET="msp430-as"
	export LD_FOR_TARGET="msp430-ld"
	export CFLAGS="-O2 -pipe"
	export CXXFLAGS="-O2 -pipe"
}

do_configure() {
#		--program-prefix=${_target}- \

	cd build
	AS_FOR_TARGET="msp430-as" LD_FOR_TARGET="msp430-ld" \
	../configure \
		--prefix=/usr \
		--target=${_target} \
		--host=$CHOST \
		--build=$CHOST \
		--enable-shared \
		--disable-nls \
		--disable-gcov \
		--disable-threads \
		--enable-languages=c,c++,lto \
		--enable-multilib \
		--with-system-zlib \
		--with-local-prefix=/usr/${_target} \
		--with-sysroot=/usr/${_target} \
		--with-as=/usr/bin/${_target}-as \
		--with-ld=/usr/bin/${_target}-ld \
		--disable-libgomp \
		--disable-libssp \
		--enable-interwork \
		--enable-addons \
		--enable-lto \
		--with-newlib
}

pre_build() {
	pre_configure
	mkdir -p aliases
	cd aliases
		for x in ar as ld; do
			printf "#!/bin/sh\\nexec msp430-$x \"$$@\"\n" > msp430-none-elf-$x
			chmod +x msp430-none-elf-$x
		done
	cd ..
	export PATH="$(realpath ./aliases):$PATH"
}

post_install() {
	rm -fr ${DESTDIR}/usr/share/{info,man/man7}
	rm -fr ${DESTDIR}/usr/lib/libcc1.*

	for x in c++ cpp g++ gcc gcc-$version gcc-ar gcc-nm gcc-ranlib lto-dump; do
		ln -s -T "msp430-none-elf-$x" "${DESTDIR}/usr/bin/msp430-$x"
	done
}
