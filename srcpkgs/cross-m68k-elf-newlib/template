# Template file for 'cross-m68k-elf-newlib'
_triplet=m68k-elf
_pkgname=newlib
pkgname=cross-${_triplet}-${_pkgname}
version=4.1.0
revision=1
wrksrc="${_pkgname}-${version}"
build_style=gnu-configure
configure_args="
 --prefix=/usr --target=${_triplet} --host=${XBPS_CROSS_TRIPLET}
 --with-gnu-as --with-gnu-ld --disable-nls
 --disable-newlib-supplied-syscalls --enable-newlib-retargetable-locking
"
hostmakedepends="cross-$_triplet-binutils cross-$_triplet-gcc"
short_desc="C library intended for use on embedded systems (Motorola 68k target)"
maintainer="PoroCYon <porocyon@titandemo.org>"
license="GPL-3.0-or-later"
homepage="https://www.sourceware.org/${_pkgname}/"
distfiles="ftp://sourceware.org/pub/${_pkgname}/${_pkgname}-${version}.tar.gz"
checksum=f296e372f51324224d387cc116dc37a6bd397198756746f93a2b02e9a5d40154
nostrip=yes

post_extract() {
	mkdir -p build-{newlib,nano}
}

do_configure() {
	pushd build-newlib
	export CFLAGS_FOR_TARGET="-g -O2 -ffunction-sections -fdata-sections"
	../configure ${configure_args} \
		--enable-newlib-io-long-long \
		--enable-newlib-register-fini
	popd

	pushd build-nano
	export CFLAGS_FOR_TARGET="-g -Os -ffunction-sections -fdata-sections"
	../configure ${configure_args} \
		--enable-newlib-reent-small \
		--disable-newlib-fvwrite-in-streamio \
		--disable-newlib-fseek-optimization \
		--disable-newlib-wide-orient \
		--enable-newlib-nano-malloc \
		--disable-newlib-unbuf-stream-opt \
		--enable-lite-exit \
		--enable-newlib-global-atexit \
		--enable-newlib-nano-formatted-io
	popd
}

do_build() {
	pushd build-newlib
	make ${makejobs}
	popd

	pushd build-nano
	make ${makejobs}
	popd
}

do_install() {
	pushd build-nano
	make DESTDIR=${DESTDIR} install
	find ${DESTDIR} -regex ".*/lib\(c\|g\|m\|rdimon\|gloss\|nosys\|semihost\|sim\)\.a" \
		-exec rename .a _nano.a '{}' \;
	install -d ${DESTDIR}/usr/${_triplet}/include/newlib-nano
	install -m644 -t ${DESTDIR}/usr/${_triplet}/include/newlib-nano \
		${DESTDIR}/usr/${_triplet}/include/newlib.h
	popd

	pushd build-newlib
	make DESTDIR=${DESTDIR} install
	popd
}

post_install() {
	vlicense COPYING
}
